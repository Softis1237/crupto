# Отказоустойчивость фида

## Потоки и back-off
- Основной источник: CCXT WebSocket (`use_websocket=1`), fallback — REST-поллинг.
- При ошибке `watch_ohlcv` → деградация и переключение на REST с экспоненциальным back-off (1s→2s→4s, максимум 30s + jitter).
- REST-запросы выполняются с `enableRateLimit=True`, при `429/5xx` используется повтор с удвоением задержки (до 60s).

## Backfill и кеширование
- На старте загружается минимум 2000 баров на каждый символ/таймфрейм (кольцевой буфер `maxlen=5000`).
- Буфер хранится в памяти; слои orchestration получают срезы через `snapshot(min_bars)`.
- В случае пропуска баров `allow_gap_fill=True` инициирует доскачку через REST; при отключении — выбрасывается `FeedIntegrityError` и процесс переводится в паузу.

## Мониторинг здоровья
- Метрика `feed_health` обновляется при каждой вставке бара: дрейф >1500 мс → статус `0 (degraded)`, иначе `1 (ok)`; при остановке — `-1 (paused)`.
- Все переходы состояния отображаются в Grafana (панель Status History) и фиксируются в `reports/telemetry_events.csv`.

## Переподключения и fallback-биржа
- WS: повторные подключения до стабилизации, после чего safe-mode удерживает REST-поллинг параллельно.
- При длительной деградации (>5 мин) `runner` переводит пайплайн в hold (нет новых планов, feed_health=0).
- Зарезервирован интерфейс `serve_prometheus` и `MarketDataFeed.update_correlation` для последующего переключения на альтернативную биржу (OKX/Kraken) через маппинг символов и нормализацию формата.

## Персистентность и выгрузки
- Все заявки, трейды, позиции и equity снапшоты сохраняются в SQLite (`storage/crupto.db`).
- Экспорт отчётов осуществляется через `scripts/run_paper_60m.sh` → `prod_core.persist.export_run` (Parquet + CSV + summary.md).
- Временные ряды латентности пишутся в таблицу `latency` и доступны для анализа (Prometheus + parquet).

## Gap-policy и паузы
- Несущественные дыры (<5*tf) заполняются RESTом; крупные разрывы переводят feed в paused-состояние до ручного вмешательства.
- При активном gap или сетевых отказах `RiskManagerAgent` не выдаёт планы (проверка через состояние портфеля).
