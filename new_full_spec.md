# Полное техническое задание (финальная версия)

## 1. Общее описание

Проект представляет собой **мультиагентную торговую систему для криптовалют**, написанную на Python.  Система реализует **стратегии автотрейдинга** в режиме *paper* (бумажного трейдинга), управляя риском, размером позиций и портфельными ограничениями.  Система основана на модульной архитектуре с разделением на ядро торговой логики, слой агентов‑оркестраторов, набор детерминированных инструментов и слой исследований (research pipeline).  Все телеграм‑боты и уведомления удалены: обмен состоянием осуществляется через **Prometheus/Grafana** и журналы.  

Проект предназначен для того, чтобы начинать со стартового капитала около **$300** и постепенно выходить на прибыль порядка **$1 000 в месяц** (в дальнейшем до 10 000 $/мес).  Это достигается либо через копитрейдинг/социальную торговлю, либо через продажу подписок на сигналы, либо через управляющий счёт.  Дисциплинированный риск‑менеджмент и прозрачная статистика позволяют привлекать сторонний капитал.

## 2. Структура репозитория

```
repo/
├── README.md                      # краткое описание проекта, установка и запуск
├── reports/                       # отчёты и протоколы
│   ├── 00_repo_audit.md          # аудит структуры и прогресса
│   ├── 01_execution_plan.md      # план работ по дням
│   ├── 02_acceptance_checklist.md# чек‑лист принятия (coverage, run 24h и др.)
│   ├── summary_latest.md         # актуальный отчёт о прогрессе
│   └── …
├── prod_core/                    # боевое ядро (только paper‑режим)
│   ├── data/                     # подключение к биржам, счётчик свеч, снапшоты
│   ├── indicators/               # тех. индикаторы: ATR, ADX, историческая вола
│   ├── strategies/               # детерминированные стратегии
│   ├── risk/                     # движок риска (RiskEngine), настройки
│   ├── exec/                     # исполнение ордеров и портфель (PortfolioController)
│   ├── monitor/                  # TelemetryExporter, Prometheus exporter
│   ├── configs/                  # YAML‑конфиги (governance.yaml, enable_map.yaml)
│   ├── persist/                  # слой хранения (SQLite/Parquet)
│   └── runner.py                 # CLI‑точка входа (paper loop)
├── brain_orchestrator/           # слой оркестрации и агентов
│   ├── agents/                   # агенты: режим рынка, выбор стратегии, риск‑менеджер, исполнение, мониторинг
│   ├── tools/                    # инструменты (модульные функции) для агентов
│   ├── regimes.py                # определение рыночных режимов
│   ├── brain.py                  # основной оркестратор, связывает агентов
│   └── tools/base.py             # базовые классы ToolSpec, ToolContext
├── tools/                        # инструменты, регистрируемые в ToolRegistry
│   ├── tools_strategy_selection_agent/
│   │   ├── strategy_scorer.py   # эвристический скоринг стратегий
│   │   ├── cooldown_manager.py  # управление cooldown
│   ├── tools_risk_manager_agent/
│   │   ├── dd_guard.py          # отсекание по дневной просадке и trailing DD
│   │   ├── position_sizer.py    # увеличение/уменьшение размера по уверенности
│   │   └── stop_planner.py      # выставление стопов и тейков по ATR
│   └── tools_execution_agent/    # оценка ликвидности, слипидж, выставление ордеров
├── dashboards/                   # Grafana экспорты
│   ├── exporter.py               # HTTP‑сервер для Prometheus ( /metrics, /graph )
│   └── grafana/                 # JSON‑дашборды с node‑graph
├── research_lab/                 # песочница: генерация новых стратегий, бэктесты
│   ├── dsl/                      # формализация описания стратегий
│   ├── generators/              # генерация кандидатов стратегий (LLM)
│   ├── tests/                   # анти‑lookahead тесты
│   ├── backtests/               # Jupyter‑ноутбук vectorbt_runner
│   └── pipeline_ci/             # champion/challenger пайплайн и гейты
├── scripts/                      # скрипты запуска: run_paper.sh, run_live.sh (жизнь только после Acceptance)
└── tests/                        # модульные и интеграционные тесты
```

## 3. Основные компоненты

### 3.0 Виртуальная торговля (VST)

- Используются переменные окружения `USE_VIRTUAL_TRADING`, `VIRTUAL_ASSET` и `VIRTUAL_EQUITY`; при включённом режиме брокер помечает сделки полем `virtual_asset`, а PortfolioController рассчитывает риск от виртуального баланса.
- Адаптер `prod_core/exchanges/bingx_adapter.py` не должен выполнять синхронные HTTP-запросы внутри `async`-функций — используйте `aiohttp` или `ccxt.async_support`.
- Предусмотрите модуль `prod_core/exchanges/bingx_virtual.py` с функцией `run_virtual_vst_cycle`, которая открывает и закрывает позицию VST/USDT в paper-режиме через CCXTBroker.
- Добавьте длительный paper-скрипт `scripts/run_paper_vst.sh`: устанавливает `USE_VIRTUAL_TRADING=true`, запускает runner на 8 часов, сохраняет логи/метрики и формирует отчёт `reports/run_<RUN_ID>/virtual_summary.md`.
- Интеграционный тест `tests/test_bingx_virtual_trade.py` должен использовать фиктивный API-ключ, выполнять виртуальный цикл и проверять наличие `virtual_asset` в ордерах, позициях и сделках без подключения к бирже.

### 3.1 Стратегии (`prod_core/strategies`)

Реализованы детерминированные торговые стратегии:

- **Breakout4HStrategy**: пробой диапазонов Donchian (20/55) с фильтром ADX, частичные тейки 1R и 2R;
- **VolatilityExpansion15MStrategy**: вход при росте ATR% и объёма выше 80‑го квантиля; выход — трейлинг 1.5×ATR и тайм‑стоп;
- **RangeReversion5MStrategy**: контртрендовая на спокойных рынках, использует RSI/BB для возврата к середине диапазона; активна только в `range_lowvol` режиме;
- **FundingReversionStrategy**: для perpetual контрактов; вход при экстремальном funding и basis, рассчитывает возврат к справедливой цене;
- **Shadow‑стратегии** (challengers) загружаются из `research_lab/backtests/vectorbt_runner.py` по конфигу `CHALLENGER_CONFIG`.

### 3.2 Движок риска (`prod_core/risk/engine.py`)

Класс **RiskEngine** реализует расчёт риска и размера позиции. Основные особенности:

- параметры (RiskSettings) определяют базовый риск на сделку (0.8 %), бонус при положительном дневном PnL, максимальный риск на сделку, дневной лимит убытка (1.8 %), лимит просадки за 72 часа (3.5 %), ограничение плеча (3×) и др.;
- метод `risk_budget_pct(state)` возвращает доступный риск, учитывая дневной PnL, trailing drawdown, невыполненный риск портфеля;
- метод `size_position(signal, entry_price, state, atr)` рассчитывает количество контрактов исходя из капитала, риска в процентах и расстояния до стопа (ATR или fixed percentage), затем ограничивает позицию по плечу;
- динамическое снижение риска при серии убытков или высокой волатильности через `_apply_dynamic_reduction()`.

### 3.3 Портфельный контроллер (`prod_core/exec/portfolio.py`)

Класс **PortfolioController** отвечает за портфельные лимиты: суммарный риск, одновременный риск на одну сделку, валовую и чистую экспозицию, корреляции между парами. Реализован механизм *safe‑mode*:

- хранит pending‑планы позиций и пересчитывает `current_risk`, `gross_exposure_pct`, `net_exposure_pct`;
- проверяет корреляции (через `update_correlation()`) и, если максимальная корреляция ≥ 0.65, включает safe‑mode: уменьшает `risk_cap_pct` согласно степени корреляции, либо блокирует открытие новых позиций (опция `safe_mode_action`);
- после исполнения ордеров (`apply_fill()`) обновляет позиции в базе данных, реализованный PnL, equity, фиксирует drawdown и накопленный PnL в процентах риска;
- сохраняет снимки equity в `PersistDAO` для последующего анализа.

### 3.4 Агенты и Оркестратор (`brain_orchestrator`)

- **MarketRegimeAgent**: определяет режим рынка (`trend_up`, `trend_down`, `range_lowvol`, `range_highvol`, `panic`) по фичам ATR, ADX, наклону EMA200, квантилю волатильности и флагу паники. Результат используется для включения/отключения стратегий;
- **StrategySelectionAgent**: использует инструменты `load_enable_map` (читает YAML‑enable_map), `score_strategy` (эвристический скоринг по доходности и волатильности) и `manage_cooldown` (не допускает повторных запусков до истечения `cooldown_bars`). Возвращает список стратегий, разрешённых в текущем режиме;
- **RiskManagerAgent**: при помощи инструментов `guard_drawdown`, `plan_position` и `plan_stops` вычисляет RiskState, проверяет лимиты (daily max loss, kill‑switch), затем для каждой стратегии и её сигналов рассчитывает объём позиции (`RiskEngine.size_position()`), множитель уверенности (`position_sizer`), стоп‑уровни (`stop_planner`), и проверяет портфельные ограничения (`PortfolioController.can_allocate()`). Если всё проходит, собирает план сделки;
- **ExecutionAgent**: реализует проверку ликвидности, вычисляет проскальзывание, выставляет ордера через брокерский слой (`place_order`) и сообщает обратно о статусе исполнения. Сохраняет результат в `PersistDAO`;
- **MonitorAgent**: экспортирует метрики в Prometheus, обновляет TelemetryExporter (PnL, DD, средний спред, количество отклонённых сигналов) и сохраняет статистику вызовов инструментов и латентность каждого этапа;
- **BrainOrchestrator**: объединяет агентов в единую цепочку: определяет режим → выбирает стратегии → просчитывает риск → исполняет планы → мониторит. Реализует ежедневную блокировку торговли при достижении лимитов и kill‑switch. Поддерживает кастомные challenger‑стратегии и режим shadow‑логирования.

### 3.5 Инструменты (`tools/`)

Инструменты являются простыми функциями с описанием `ToolSpec` (capability, agent, safety_tags, cost_hint_ms). Они регистрируются в `ToolRegistry`.  В проекте реализованы:

- **strategy_scorer** — вычисляет балл стратегии на основе доходности, волатильности и принадлежности к mean‑reversion (балл инвертируется для диапазонных стратегий);
- **cooldown_manager** — следит за `cooldown_state` и разрешает повторный запуск стратегии только после заданного числа баров;
- **dd_guard** — блокирует риск‑менеджер, если дневная просадка ≤ −1.8 % или trailing DD ≤ −3.5 %; 
- **position_sizer** — масштабирует размер позиции по уверенности сигнала и ATR (множитель 0.5…1.5);
- **stop_planner** — выставляет stop‑loss и take‑profit относительно ATR с коэффициентом 1.2/2.5;
- **execution/liquidity_check**, `slippage_estimator`, `place_order` — оценивают ликвидность, рассчитывают ожидаемое проскальзывание и ставят ордера через CCXT;
- **export_metrics** — экспортирует в Prometheus метрики состояния агентов, стратегий и вызовов инструментов.

### 3.6 Конфигурация

- **governance.yaml** — жёсткие лимиты риска (доля риска на сделку, max_daily_loss_pct, kill_switch_drawdown_72h, leverage_cap, max_portfolio_r_pct и т. д.). Эти поля LOCKED и не могут изменяться в рантайме.
- **enable_map.yaml** — карта режимов → список разрешённых стратегий. Содержит также параметры hysteresis (min_bars_hold), cooldown_after_2_losses и др. Допускается модификация через research pipeline.
- **symbols.yaml** — список торгуемых инструментов и настройки фидов (таймфреймы, poll_interval_seconds, backfill_bars). Поддерживает запись нескольких таймфреймов (1m, 5m, 15m, 1h, 4h).  

### 3.7 Мониторинг и Grafana

- **TelemetryExporter** в `prod_core/monitor/telemetry.py` записывает события в CSV и поддерживает счётчики (RPS, latency и др.).
- **dashboards/exporter.py** поднимает HTTP‑эндпоинт `/metrics` и `/graph`. `/metrics` экспортирует метрики Prometheus (состояние агентов, включённые стратегии, PnL, DD, количество ордеров, задержки, проскальзывание, состояние `safe_mode`, daily lock, kill‑switch). `/graph` отдаёт JSON, описывающий текущий граф агентов (узлы brain/regime/strategy/risk/exec/monitor и стрелки вызовов).   
- **Grafana dashboards** находятся в `dashboards/grafana/`. Файл `dashboard_nodes.json` показывает node‑graph с цветовой кодировкой: зелёный — агент/инструмент работает нормально; жёлтый — предупреждение; красный — ошибка; серый — отключено. Файл `dashboard_ops.json` выводит PnL, DD, задержки и число активных стратегий.

## 4. Результаты текущей реализации (анализ репозитория)

На момент аудита (октябрь 2025) проект `Softis1237/crupto` реализован в соответствии с заявленной архитектурой:

- **Функциональные модули** — полностью реализованы: `RiskEngine`, `PortfolioController`, все четыре стратегии, persistent слой, загрузчик конфигов, `BrainOrchestrator` с пятью агентами, `ToolRegistry` и набор инструментов.  Код хорошо структурирован, покрыт комментариями на русском, соответствует ТЗ.
- **Telemetry/Prometheus** — реализованы: `serve_prometheus` запускает HTTP‑экспорт на порту, Grafana dashboards подготовлены, метрики агентов/стратегий экспортируются.  В `reports/summary_latest.md` отмечены достижения: подключён mock‑feed, добавлены флаги `--skip-feed-check`/`--use-mock-feed`, расширен персист‑слой и экспорт проектов; тестовое покрытие доведено до ~79 %, кратковременный paper‑run отработал.
- **Safe‑mode и корреляции** — в `PortfolioController` реализован продвинутый контроль корреляций (safe‑mode).  При превышении порога 0.65 активируется снижение лимита риска, вплоть до блокировки.  Это улучшение по сравнению с исходным ТЗ.
- **Постоянное хранилище** — используется SQLite через `PersistDAO` и Parquet‑файлы.  Equity, PnL, позиции и сделки сохраняются, что позволяет анализировать историю и сбрасывать state при рестарте.
- **Отказоустойчивость** — runner поддерживает мягкое завершение по сигналам, крон‑флаг max_seconds/max_cycles, skip_feed_check для отладки, и kill‑switch/daily lock.  Были добавлены mock‑feed для автономной проверки.

### Недостающие части / планы

В файлах `reports/00_repo_audit.md`, `reports/01_execution_plan.md`, `reports/02_acceptance_checklist.md` отмечены следующие задачи:

- **Integration tests**: требуется дописать интеграционные тесты для paper‑loop с CCXT и mock‑feed, а также тесты обработки ошибок в брокере и персист‑слое.  Сейчас юнит‑тесты покрывают ~79 % и не гарантируют отсутствие регрессий при многопоточном исполнении.
- **Research pipeline**: пока не реализована подсистема генерации/тестирования новых стратегий.  Нужно внедрить `research_lab/generators` и `pipeline_ci/gate_spec.md`: LLM формирует кандидатов, затем происходит backtest → walk‑forward → live‑shadow → canary.  После прохождения гейтов стратегия включается в `enable_map` с пометкой challenger.
- **Node Graph в Grafana**: API `/graph` реализован, но Dashboard node‑graph требует доработки — цвета узлов иногда не соответствуют реальному состоянию (желтый/красный), стрелки не всегда отображают последний вызов.  Необходимо корректно отправлять поле `active` для edges и обновлять state в Prometheus.
- **База данных**: требуется периодический cleanup (удаление старых equity snapshots/trades) и индексирование таблиц.  В `reports/00_repo_audit.md` рекомендовано добавить cron‑задачи либо автоматическое архивирование.
- **Документация**: README нуждается в обновлении под расширенные возможности: описание safe‑mode, mock‑feed, параметры запуска challenger, порядок запуска research pipeline.  Актуальные шаги должны быть отражены в вашем README и в инструкциях для Codex.

## 5. Acceptance критерии (финальные)

Для готового релиза необходимо выполнить:

1. **Test Coverage ≥ 70 %**: юнит‑тесты покрывают все основные компоненты; дополнительно присутствует набор интеграционных тестов, прогоняющих бумажный трейдинг с реальным фидом и mock‑фидом.
2. **24‑часовой paper‑run**: система непрерывно торгует в paper‑режиме без ошибок, превышения лимитов, падений и зависаний; telemetry показывает стабильность; daily lock и kill‑switch работают корректно.
3. **Графана**: dashboards `node graph` и `operations` отображают актуальные состояния агентов, количество активных стратегий, PnL, DD, риск‑капы; цвета и стрелки обновляются в режиме реального времени.
4. **Research pipeline**: хотя бы один challenger‑кандидат прошёл через backtest→walk-forward→paper→shadow и добавлен в enable_map; pipeline описан и автоматизирован (например, в GitHub Actions).
5. **Обновлённая документация**: README, SPEC, Инструкция Codex обновлены; описаны шаги установки, запуска, тестирования, мониторинга; обновлён check‑list acceptance; приведён список известных ограничений.

---

